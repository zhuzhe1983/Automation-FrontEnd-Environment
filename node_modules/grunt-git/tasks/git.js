/*
 * grunt-git
 * https://github.com/rubenv/grunt-git
 *
 * Copyright (c) 2013 Ruben Vermeersch
 * Licensed under the MIT license.
 */

'use strict';

module.exports = function (grunt) {
    grunt.registerMultiTask('git', 'Execute git commands.', function () {
        // Merge task-specific and/or target-specific options with these defaults.
        var options = this.options({
            command: 'pull'
        });


        if (options.command === 'commit') {
            var done = this.async();

            var addFile = function (file, cb) {
                grunt.util.spawn({
                    cmd: "git",
                    args: ["add", file.src]
                }, cb);
            };

            grunt.util.async.forEach(this.files, addFile, function (err) {
                grunt.util.spawn({
                    cmd: "git",
                    args: ["commit", "-m", options.message]
                }, function (err) {
                    done(!err);
                });
            });

        } else if (options.command === 'clone') {
            var done = this.async();
            console.log(["clone", options.server, options.path]);
            grunt.util.spawn({
                cmd: "git",
                args: ["clone", options.server, options.path]
            }, function (err) {
                done(!err);
            });

        }  else if (options.command === 'pull') {
            var done = this.async();
            console.log(["pull", options]);
            grunt.util.spawn({
                cmd: "git",
                args: ["pull"]
            }, function (err) {
                done(!err);
            });

        } else {
            grunt.log.error('No or unknown command specified: ' + options.command);
        }
    });

};
